const fs = require("fs");
// Use the modern pdfjs-dist path (no more "es5/")
const pdfjsLib = require("pdfjs-dist/build/pdf.js");

function pdf(dataBuffer, options = {}) {
  if (!dataBuffer) {
    return Promise.reject(new Error("No PDF data provided"));
  }

  // Convert Node Buffer â†’ Uint8Array
  const uint8Array = new Uint8Array(dataBuffer);

  return pdfjsLib.getDocument({ data: uint8Array }).promise.then((doc) => {
    let textContent = "";
    const pagePromises = [];

    for (let i = 1; i <= doc.numPages; i++) {
      pagePromises.push(
        doc.getPage(i).then((page) =>
          page.getTextContent().then((content) => {
            textContent += content.items.map((t) => t.str).join(" ") + "\n";
          })
        )
      );
    }

    return Promise.all(pagePromises).then(() => ({
      text: textContent.trim(),
      numpages: doc.numPages,
      info: doc._pdfInfo,
      metadata: doc._metadata || null,
    }));
  });
}

module.exports = pdf;
